# PostgreSQL Configuration - SECURITY HARDENED
# This file configures PostgreSQL for maximum security

# ============================================
# CONNECTION SETTINGS
# ============================================

# Listen only on internal Docker network (not public internet)
listen_addresses = '*'  # Within Docker network only
port = 5432
max_connections = 100

# ============================================
# SECURITY SETTINGS
# ============================================

# Password encryption
password_encryption = scram-sha-256

# SSL/TLS Configuration (REQUIRED for production)
ssl = on
ssl_cert_file = '/var/lib/postgresql/server.crt'
ssl_key_file = '/var/lib/postgresql/server.key'
ssl_ca_file = '/var/lib/postgresql/root.crt'
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_prefer_server_ciphers = on
ssl_min_protocol_version = 'TLSv1.2'

# ============================================
# AUTHENTICATION
# ============================================

# Require password for all connections
db_user_namespace = off

# ============================================
# LOGGING (for security auditing)
# ============================================

# Log all connections
log_connections = on
log_disconnections = on

# Log all failed connection attempts
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '

# Log all DDL statements (CREATE, ALTER, DROP)
log_statement = 'ddl'

# Log long-running queries (potential attacks)
log_min_duration_statement = 1000  # Log queries > 1 second

# Log checkpoints (for monitoring)
log_checkpoints = on

# Log lock waits (detect deadlocks)
log_lock_waits = on

# ============================================
# RESOURCE LIMITS (prevent DoS attacks)
# ============================================

# Limit memory usage
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 16MB
maintenance_work_mem = 128MB

# Limit connections per user
# (Set in pg_hba.conf)

# Statement timeout (prevent long-running queries)
statement_timeout = 30000  # 30 seconds max per query

# Lock timeout
lock_timeout = 10000  # 10 seconds max for locks

# Idle in transaction timeout
idle_in_transaction_session_timeout = 60000  # 1 minute

# ============================================
# DATA INTEGRITY
# ============================================

# Enable data checksums (detect corruption)
data_checksums = on

# Full page writes (prevent corruption)
full_page_writes = on

# Synchronous commit (ensure data durability)
synchronous_commit = on

# ============================================
# QUERY SECURITY
# ============================================

# Prevent SQL injection via prepared statements
plan_cache_mode = force_custom_plan

# ============================================
# MONITORING
# ============================================

# Track activity
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Log autovacuum (maintenance monitoring)
log_autovacuum_min_duration = 0

# ============================================
# PERFORMANCE (balanced with security)
# ============================================

# Checkpoint settings
checkpoint_timeout = 5min
checkpoint_completion_target = 0.9

# WAL settings
wal_level = replica
max_wal_size = 1GB
min_wal_size = 80MB

# ============================================
# NOTES
# ============================================
# 1. This configuration prioritizes security over performance
# 2. Adjust resource limits based on your server capacity
# 3. Enable SSL certificates in production
# 4. Monitor logs regularly for suspicious activity
# 5. Keep PostgreSQL updated to latest security patches
