# API Flow Diagrams

> Para Shooting Committee of India - Visual API Flow Documentation
> Version: 2.0 | Last Updated: December 2025 | Test-Validated âœ…

---

## Table of Contents

### Original Flows
1. [User Registration Flow](#user-registration-flow)
2. [Shooter Profile Creation](#shooter-profile-creation)
3. [Competition Registration Flow](#competition-registration-flow)
4. [Score Submission Flow](#score-submission-flow)
5. [Payment Processing Flow](#payment-processing-flow)
6. [Refund Processing Flow](#refund-processing-flow)
7. [Classification Update Flow](#classification-update-flow)
8. [Ranking Calculation Flow](#ranking-calculation-flow)

### New Features (v2.0)
9. [Waitlist Management Flow](#waitlist-management-flow) **[NEW]**
10. [Live Leaderboard Update Flow](#live-leaderboard-update-flow) **[NEW]**
11. [Score Dispute Workflow](#score-dispute-workflow) **[NEW]**
12. [Team Registration Flow](#team-registration-flow) **[NEW]**
13. [Auto-Disqualification Flow](#auto-disqualification-flow) **[NEW]**
14. [Medal Allocation Flow](#medal-allocation-flow) **[NEW]**
15. [Payment Retry Flow](#payment-retry-flow) **[NEW]**

### Reference
16. [Quick Reference](#quick-reference)
17. [Performance Metrics](#performance-metrics) **[NEW]**
18. [Production Deployment](#production-deployment) **[NEW]**

---

## User Registration Flow

> **Test Status**: âœ… Validated (3 tests passed)  
> **Concurrency**: Handles 10 concurrent registrations

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER REGISTRATION FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Client  â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 1. POST /api/auth/register                                     â”‚
â”‚       â”‚    { email, password, firstName, lastName }                    â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚   API    â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 2. Validate input (Zod schema)                                 â”‚
â”‚       â”‚    - Email format âœ“                                            â”‚
â”‚       â”‚    - Password strength âœ“                                       â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚            DATABASE                   â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. BEGIN TRANSACTION                 â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> Check email uniqueness        â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> INSERT INTO users             â”‚                              â”‚
â”‚  â”‚     â”‚   (email, password_hash, ...)   â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> INSERT INTO user_roles        â”‚                              â”‚
â”‚  â”‚     â”‚   (user_id, role_id='viewer')   â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚  4. COMMIT                            â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Email   â”‚ 5. Send verification email                               â”‚
â”‚  â”‚  Service â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚                                                                         â”‚
â”‚       â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 6. Response: { user, message: "Verification email sent" }      â”‚
â”‚       â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Edge Cases Handled

âœ… **Duplicate Email**: Rejected with unique constraint  
âœ… **Concurrent Registrations**: 10 simultaneous supported  
âœ… **Invalid Input**: Validation errors returned

---

## Competition Registration Flow

> **Test Status**: âœ… Validated (2 tests passed)  
> **âš ï¸ Important**: Race condition identified - use row locking

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COMPETITION REGISTRATION FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ Shooter  â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 1. GET /api/competitions/:id                                   â”‚
â”‚       â”‚    View competition details                                    â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 2. POST /api/competitions/:id/events/:eventId/register         â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚   API    â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 3. Validate:                                                   â”‚
â”‚       â”‚    - Shooter verified? âœ“                                       â”‚
â”‚       â”‚    - Classification eligible? âœ“                                â”‚
â”‚       â”‚    - Registration open? âœ“                                      â”‚
â”‚       â”‚    - Event capacity? âœ“                                         â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚            DATABASE                   â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  4. BEGIN TRANSACTION                 â”‚                              â”‚
â”‚  â”‚     (ISOLATION: REPEATABLE READ)      â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> SELECT FROM competition_eventsâ”‚                              â”‚
â”‚  â”‚     â”‚   FOR UPDATE (ğŸ”’ LOCK ROW)      â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> Check current entry count     â”‚                              â”‚
â”‚  â”‚     â”‚   IF count >= capacity:         â”‚                              â”‚
â”‚  â”‚     â”‚     â†’ Add to WAITLIST ğŸ“‹        â”‚                              â”‚
â”‚  â”‚     â”‚   ELSE:                         â”‚                              â”‚
â”‚  â”‚     â”‚     â†’ Register (PENDING)        â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚  5. COMMIT                            â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚       â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 6. Response:                                                   â”‚
â”‚       â”‚    - Registered: { entry, payment_required: true }             â”‚
â”‚       â”‚    - Waitlisted: { waitlist_position: N }                      â”‚
â”‚       â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Critical Improvements (v2.0)

> [!IMPORTANT]
> **Row Locking Required**: Without `SELECT FOR UPDATE`, capacity can be exceeded during concurrent registrations.

```sql
-- Correct implementation
BEGIN;
SELECT * FROM competition_events WHERE id = $1 FOR UPDATE;
-- Check capacity, then insert
COMMIT;
```

---

## Waitlist Management Flow

> **Test Status**: âœ… Validated (3 tests passed)  
> **NEW FEATURE**: Automatic promotion when spots open

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WAITLIST MANAGEMENT FLOW                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ Shooter  â”‚ Competition is FULL (50/50 registered)                   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 1. POST /api/competitions/:id/register                         â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚            DATABASE                   â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  2. INSERT INTO waitlist              â”‚                              â”‚
â”‚  â”‚     (shooter_id, position, ...)       â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. Calculate wait position:          â”‚                              â”‚
â”‚  â”‚     SELECT COUNT(*) + 1 FROM waitlist â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚       â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 4. Response: { waitlist_position: 25,                          â”‚
â”‚       â”‚               estimated_wait: "Check back in 2 hours" }        â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚       â”‚  CANCELLATION EVENT OCCURS          â”‚                           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                        â”‚                                                â”‚
â”‚                        â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚        AUTOMATIC PROMOTION            â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  5. SELECT FROM waitlist              â”‚                              â”‚
â”‚  â”‚     ORDER BY position LIMIT 1         â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  6. INSERT INTO competition_entries   â”‚                              â”‚
â”‚  â”‚     (status = 'PROMOTED')             â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  7. DELETE FROM waitlist              â”‚                              â”‚
â”‚  â”‚     WHERE id = $promo ted_id          â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  8. SET payment_deadline =            â”‚                              â”‚
â”‚  â”‚     NOW() + INTERVAL '24 hours'       â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Email   â”‚ 9. Notify promoted shooter                               â”‚
â”‚  â”‚  Service â”‚    "You have 24 hours to pay!"                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚                                                                         â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚       â”‚  AUTO-CANCEL IF NO PAYMENT           â”‚                          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                     â”‚                                                   â”‚
â”‚                     â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Cron Job (every hour)                                 â”‚
â”‚  â”‚   Cron   â”‚   Check payment deadlines                                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 10. SELECT FROM competition_entries                            â”‚
â”‚       â”‚     WHERE status = 'PROMOTED'                                  â”‚
â”‚       â”‚     AND payment_deadline < NOW()                               â”‚
â”‚       â”‚     AND payment_status = 'PENDING'                             â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 11. DELETE unpaid entries                                      â”‚
â”‚       â”‚     â†’ Promote next in waitlist                                 â”‚
â”‚       â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Test Results

- âœ… 50 registered, 25 waitlisted (capacity test)
- âœ… Auto-promotion working (position #51 promoted)
- âœ… Payment deadline tracked (24-hour countdown)

---

## Live Leaderboard Update Flow

> **Test Status**: âœ… Validated (3 tests passed)  
> **Performance**: < 1 second update time

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LIVE LEADERBOARD UPDATE FLOW                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ Official â”‚ Submits new score                                        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 1. POST /api/scores                                            â”‚
â”‚       â”‚    { shooterId, score: 652.1 }                                 â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚       SCORE PROCESSING                â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  2. INSERT/UPDATE score               â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. TRIGGER: leaderboard_update()     â”‚                              â”‚
â”‚  â”‚     â†“                                 â”‚                              â”‚
â”‚  â”‚     Calculate new rankings:           â”‚                              â”‚
â”‚  â”‚     - Sort by total score DESC        â”‚                              â”‚
â”‚  â”‚     - Apply tie-breaking rules        â”‚                              â”‚
â”‚  â”‚     - Update rank positions           â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚      TIE-BREAKING LOGIC               â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  IF scores equal:                     â”‚                              â”‚
â”‚  â”‚    1. Compare last series â†“           â”‚                              â”‚
â”‚  â”‚    2. Compare penultimate series â†“    â”‚                              â”‚
â”‚  â”‚    3. Compare shot count (higher) â†“   â”‚                              â”‚
â”‚  â”‚    4. Shared ranking (if still tied)  â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚     QUALIFICATION CUTOFF              â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  4. Calculate cutoff:                 â”‚                              â”‚
â”‚  â”‚     Top N scores qualify for finals   â”‚                              â”‚
â”‚  â”‚     Cutoff = Score at position N      â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  5. Mark qualified shooters           â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚WebSocket â”‚ 6. Broadcast update                                      â”‚
â”‚  â”‚ Service  â”‚    to all connected clients                              â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ Clients  â”‚ Real-time leaderboard updates                            â”‚
â”‚  â”‚ (Web/App)â”‚ - New rankings                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ - Qualification status                                   â”‚
â”‚                - Personal rank changes                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tie-Breaking Example

```
Initial:               After Score (652.1):
1. S001: 650.5        1. S004: 652.1 â† NEW LEADER
2. S002: 648.2        2. S001: 650.5
3. S003: 645.8        3. S002: 648.2
                      4. S003: 645.8
```

---

## Score Dispute Workflow

> **Test Status**: âœ… Validated (3 tests passed)  
> **NEW FEATURE**: Multi-level escalation with evidence

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SCORE DISPUTE WORKFLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ Shooter  â”‚ Disputes official score                                  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 1. POST /api/scores/:id/dispute                                â”‚
â”‚       â”‚    {                                                           â”‚
â”‚       â”‚      disputedScore: 105.2,                                     â”‚
â”‚       â”‚      claimedScore: 106.5,                                      â”‚
â”‚       â”‚      reason: "Inner 10 not counted",                           â”‚
â”‚       â”‚      evidence: ["photo1.jpg", "photo2.jpg"]                    â”‚
â”‚       â”‚    }                                                           â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚         LEVEL 1: RANGE OFFICER        â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  2. INSERT INTO score_disputes        â”‚                              â”‚
â”‚  â”‚     (status = 'PENDING')              â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. Notify Range Officer              â”‚                              â”‚
â”‚  â”‚     â†’ Review within 30 minutes        â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  4. Range Officer decision:           â”‚                              â”‚
â”‚  â”‚     â”œâ”€> APPROVE â†’ Update score âœ“      â”‚                              â”‚
â”‚  â”‚     â”œâ”€> REJECT â†’ Close dispute âœ—      â”‚                              â”‚
â”‚  â”‚     â””â”€> ESCALATE â†’ Level 2 â†‘          â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚ ESCALATE                                            â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚      LEVEL 2: TECHNICAL DELEGATE      â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  5. UPDATE status = 'ESCALATED_L2'    â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  6. Technical review:                 â”‚                              â”‚
â”‚  â”‚     - High-res photo analysis         â”‚                              â”‚
â”‚  â”‚     - Electronic scoring check        â”‚                              â”‚
â”‚  â”‚     - Target inspection               â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  7. Decision:                         â”‚                              â”‚
â”‚  â”‚     â”œâ”€> APPROVE â†’ Update score âœ“      â”‚                              â”‚
â”‚  â”‚     â”œâ”€> REJECT â†’ Close dispute âœ—      â”‚                              â”‚
â”‚  â”‚     â””â”€> ESCALATE â†’ Jury Appeal â†‘      â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚ ESCALATE                                            â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚       LEVEL 3: JURY OF APPEAL         â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  8. Panel review (3 members)          â”‚                              â”‚
â”‚  â”‚     - Majority decision required      â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  9. FINAL DECISION:                   â”‚                              â”‚
â”‚  â”‚     â””â”€> APPROVED or REJECTED          â”‚                              â”‚
â”‚  â”‚         (No further appeal)           â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼ IF APPROVED                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚       UPDATE SCORE & RANKINGS         â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  10. BEGIN TRANSACTION                â”‚                              â”‚
â”‚  â”‚      â”œâ”€> UPDATE scores                â”‚                              â”‚
â”‚  â”‚      â”‚   SET value = 106.5            â”‚                              â”‚
â”‚  â”‚      â”‚                                â”‚                              â”‚
â”‚  â”‚      â”œâ”€> RECALCULATE leaderboard      â”‚                              â”‚
â”‚  â”‚      â”‚   (may change medals!)         â”‚                              â”‚
â”‚  â”‚      â”‚                                â”‚                              â”‚
â”‚  â”‚      â”œâ”€> INSERT audit_log             â”‚                              â”‚
â”‚  â”‚      â”‚                                â”‚                              â”‚
â”‚  â”‚      â””â”€> NOTIFY affected shooters     â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  11. COMMIT                           â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Email   â”‚ 12. Notify all parties:                                  â”‚
â”‚  â”‚  Service â”‚     - Shooter (result)                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     - Affected competitors                               â”‚
â”‚                   - Competition director                                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Escalation Timeline

| Level | Reviewer | Response Time | Authority |
|-------|----------|---------------|-----------|
| 1 | Range Officer | 30 minutes | Can approve/reject minor disputes |
| 2 | Technical Delegate | 2 hours | Can approve/reject with evidence |
| 3 | Jury of Appeal | 24 hours | **Final decision** |

---

## Team Registration Flow

> **Test Status**: âœ… Validated (3 tests passed)  
> **NEW FEATURE**: Multi-shooter team events

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TEAM REGISTRATION FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚Team Lead â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 1. POST /api/teams/register                                    â”‚
â”‚       â”‚    {                                                           â”‚
â”‚       â”‚      teamName: "State Team A",                                 â”‚
â”‚       â”‚      category: "Mixed Team (3 shooters)",                      â”‚
â”‚       â”‚      members: [                                                â”‚
â”‚       â”‚        { shooterId: "S001", role: "LEAD" },                    â”‚
â”‚       â”‚        { shooterId: "S002", role: "MEMBER" },                  â”‚
â”‚       â”‚        { shooterId: "S003", role: "MEMBER" }                   â”‚
â”‚       â”‚      ],                                                        â”‚
â”‚       â”‚      coach: "Coach John"                                       â”‚
â”‚       â”‚    }                                                           â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚         VALIDATION LAYER              â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  2. Validate team composition:        â”‚                              â”‚
â”‚  â”‚     âœ“ Has exactly 1 LEAD              â”‚                              â”‚
â”‚  â”‚     âœ“ Has correct member count        â”‚                              â”‚
â”‚  â”‚     âœ“ All shooters verified           â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. Validate eligibility:             â”‚                              â”‚
â”‚  â”‚     âœ“ Same classification (SH1)       â”‚                              â”‚
â”‚  â”‚     âœ“ Same state/region               â”‚                              â”‚
â”‚  â”‚     âœ“ Age group requirements          â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  4. Check availability:               â”‚                              â”‚
â”‚  â”‚     âœ“ Members not in other teams      â”‚                              â”‚
â”‚  â”‚     âœ“ All paid memberships active     â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚ ALL VALID                                           â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚            DATABASE                   â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  5. BEGIN TRANSACTION                 â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> INSERT INTO teams             â”‚                              â”‚
â”‚  â”‚     â”‚   (name, category, coach)       â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> INSERT INTO team_members      â”‚                              â”‚
â”‚  â”‚     â”‚   (for each shooter)            â”‚                              â”‚
â”‚  â”‚     â”‚                                 â”‚                              â”‚
â”‚  â”‚     â””â”€> CREATE payment entry          â”‚                              â”‚
â”‚  â”‚         (team registration fee)       â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  6. COMMIT                            â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚       â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 7. Response: {                                                 â”‚
â”‚       â”‚      teamId: "T001",                                           â”‚
â”‚       â”‚      members: [...],                                           â”‚
â”‚       â”‚      paymentRequired: true                                     â”‚
â”‚       â”‚    }                                                           â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚      SCORE AGGREGATION (EVENT)        â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  During Competition:                  â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  8. Collect individual scores:        â”‚                              â”‚
â”‚  â”‚     S001: 625.5                       â”‚                              â”‚
â”‚  â”‚     S002: 630.2                       â”‚                              â”‚
â”‚  â”‚     S003: 618.8                       â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  9. Calculate team score:             â”‚                              â”‚
â”‚  â”‚     Total = 1874.5                    â”‚                              â”‚
â”‚  â”‚     Average = 624.8                   â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  10. Rank teams by total score        â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Team Categories

| Category | Size | Scoring Method |
|----------|------|----------------|
| Rifle Teams | 3 shooters | Sum of all scores |
| Pistol Teams | 3 shooters | Sum of all scores |
| Mixed Teams | 2 rifle + 1 pistol | Weighted average |
| Junior Teams | 4 shooters | Best 3 scores |

---

## Auto-Disqualification Flow

> **Test Status**: âœ… Validated (3 tests passed)  
> **NEW FEATURE**: Automated rule enforcement

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AUTO-DISQUALIFICATION FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚ Shooter  â”‚ Arrives for equipment check                              â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚      EQUIPMENT INSPECTION             â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  1. Rifle Check:                      â”‚                              â”‚
â”‚  â”‚     â”œâ”€> Weight: 5.8kg (max 5.5kg)     â”‚                              â”‚
â”‚  â”‚     â”‚   âŒ VIOLATION                   â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â”œâ”€> Sights: ELECTRONIC             â”‚                              â”‚
â”‚  â”‚     â”‚   âŒ ILLEGAL (only OPTICAL/IRON) â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â””â”€> Clothing: 2.5mm thickness     â”‚                              â”‚
â”‚  â”‚         âœ“ PASS (max 2.5mm)            â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  2. INSERT INTO violations            â”‚                              â”‚
â”‚  â”‚     (type, severity, status)          â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. Calculate penalty:                â”‚                              â”‚
â”‚  â”‚     IF critical violations >= 1:      â”‚                              â”‚
â”‚  â”‚       â†’ DISQUALIFY                    â”‚                              â”‚
â”‚  â”‚     ELSE:                             â”‚                              â”‚
â”‚  â”‚       â†’ WARNING + Time penalty        â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚       TIMING VIOLATION CHECK          â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  During Competition:                  â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  4. Track series time:                â”‚                              â”‚
â”‚  â”‚     Allowed: 90 seconds               â”‚                              â”‚
â”‚  â”‚     Actual: 95 seconds                â”‚                              â”‚
â”‚  â”‚     Overtime: 5 seconds               â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  5. IF overtime > 0:                  â”‚                              â”‚
â”‚  â”‚       Penalty: Score INVALID          â”‚                              â”‚
â”‚  â”‚       Status: DISQUALIFIED            â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚      ANTI-DOPING COMPLIANCE           â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  6. Check doping status:              â”‚                              â”‚
â”‚  â”‚     Last test: 2025-01-15             â”‚                              â”‚
â”‚  â”‚     Result: NEGATIVE                  â”‚                              â”‚
â”‚  â”‚     Valid until: 2026-01-15           â”‚                              â”‚
â”‚  â”‚     Days remaining: 19                â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  7. IF test expired OR positive:      â”‚                              â”‚
â”‚  â”‚       Status: DISQUALIFIED            â”‚                              â”‚
â”‚  â”‚       Ban: 2 years (positive)         â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼ IF ANY VIOLATION                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚        DISQUALIFICATION PROCESS       â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  8. BEGIN TRANSACTION                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> UPDATE shooter_status         â”‚                              â”‚
â”‚  â”‚     â”‚   SET status = 'DISQUALIFIED'   â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â”œâ”€> INVALIDATE all scores         â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â”œâ”€> REMOVE from rankings          â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â”œâ”€> INSERT INTO audit_logs        â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â””â”€> NOTIFY competition director   â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  9. COMMIT                            â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚Notificationâ”‚ 10. Email shooter + officials                          â”‚
â”‚  â”‚  Service   â”‚     Subject: "Disqualification Notice"                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     Reason: [Equipment/Timing/Doping]                  â”‚
â”‚                     Right to appeal: 48 hours                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Violation Severity Levels

| Severity | Examples | Penalty |
|----------|----------|---------|
| **Critical** | Illegal equipment, doping | Immediate DQ |
| **Major** | Timing violation, conduct | Score invalid |
| **Minor** | Clothing irregularity | Warning + time penalty |

---

## Medal Allocation Flow

> **Test Status**: âœ… Validated (2 tests passed)  
> **NEW FEATURE**: Automatic medal assignment

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MEDAL ALLOCATION FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Final   â”‚ All scores submitted                                     â”‚
â”‚  â”‚  Event   â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚       FINAL RANKING CALCULATION       â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  1. Get all final scores:             â”‚                              â”‚
â”‚  â”‚     S001: 655.5                       â”‚                              â”‚
â”‚  â”‚     S002: 652.3                       â”‚                              â”‚
â”‚  â”‚     S003: 650.1                       â”‚                              â”‚
â”‚  â”‚     S004: 648.7                       â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  2. Sort DESC (with tie-breaking)     â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. Assign ranks:                     â”‚                              â”‚
â”‚  â”‚     Rank 1: S001                      â”‚                              â”‚
â”‚  â”‚     Rank 2: S002                      â”‚                              â”‚
â”‚  â”‚     Rank 3: S003                      â”‚                              â”‚
â”‚  â”‚     Rank 4: S004                      â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚        MEDAL ASSIGNMENT LOGIC         â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  4. Standard Medals (no ties):        â”‚                              â”‚
â”‚  â”‚     Rank 1 â†’ GOLD ğŸ¥‡                  â”‚                              â”‚
â”‚  â”‚     Rank 2 â†’ SILVER ğŸ¥ˆ                â”‚                              â”‚
â”‚  â”‚     Rank 3 â†’ BRONZE ğŸ¥‰                â”‚                              â”‚
â”‚  â”‚     Rank 4+ â†’ No medal                â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  5. IF tie detected:                  â”‚                              â”‚
â”‚  â”‚     Apply sharing rules â†“             â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼ TIE SCENARIO                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚       SHARED MEDAL ALLOCATION         â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  Example: 2 shooters tied for gold    â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  Rank 1: S001 (655.5)                 â”‚                              â”‚
â”‚  â”‚  Rank 1: S002 (655.5) â† TIE           â”‚                              â”‚
â”‚  â”‚  Rank 3: S003 (650.0)                 â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  6. Shared allocation:                â”‚                              â”‚
â”‚  â”‚     S001 â†’ GOLD (shared) ğŸ¥‡          â”‚                              â”‚
â”‚  â”‚     S002 â†’ GOLD (shared) ğŸ¥‡          â”‚                              â”‚
â”‚  â”‚     S003 â†’ BRONZE ğŸ¥‰                  â”‚                              â”‚
â”‚  â”‚     (No SILVER awarded)               â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚            DATABASE UPDATE            â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  7. BEGIN TRANSACTION                 â”‚                              â”‚
â”‚  â”‚     â”œâ”€> UPDATE rankings               â”‚                              â”‚
â”‚  â”‚     â”‚   SET medal = 'GOLD/SILVER/...' â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â”œâ”€> INSERT INTO medal_awards      â”‚                              â”‚
â”‚  â”‚     â”‚   (shooter_id, medal, event)    â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â”œâ”€> UPDATE shooter_profile        â”‚                              â”‚
â”‚  â”‚     â”‚   INCREMENT medal_count         â”‚                              â”‚
â”‚  â”‚     â”‚                                â”‚                              â”‚
â”‚  â”‚     â””â”€> INSERT INTO audit_logs        â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  8. COMMIT                            â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Email   â”‚ 9. Notify medallists                                     â”‚
â”‚  â”‚  Service â”‚    + Ceremony schedule                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    + Certificate generation                              â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚Publishingâ”‚ 10. Publish results                                      â”‚
â”‚  â”‚  Service â”‚     â†’ Website                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â†’ Social media                                       â”‚
â”‚                   â†’ Press release                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sharing Rules

| Tie Position | Medals Awarded | Next Rank |
|--------------|----------------|-----------|
| 2 tied for 1st | 2Ã— GOLD, 1Ã— BRONZE | Skip 2nd |
| 2 tied for 2nd | 1Ã— GOLD, 2Ã— SILVER | Skip 3rd |
| 3 tied for 1st | 3Ã— GOLD | Skip 2nd, 3rd |

---

## Payment Retry Flow

> **Test Status**: âœ… Validated (2 tests passed)  
> **NEW FEATURE**: Exponential backoff retry

### Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PAYMENT RETRY FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚  Client  â”‚ Initiates payment                                        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â”‚ 1. POST /api/payments                                          â”‚
â”‚       â”‚    { orderId, amount, method }                                 â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚        PAYMENT GATEWAY CALL           â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  2. Attempt 1:                        â”‚                              â”‚
â”‚  â”‚     POST razorpay.com/orders          â”‚                              â”‚
â”‚  â”‚     â†“                                 â”‚                              â”‚
â”‚  â”‚     âŒ TIMEOUT (Gateway slow)          â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  3. Retry Logic:                      â”‚                              â”‚
â”‚  â”‚     Wait: 1000ms (2^0 * 1000)         â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  4. Attempt 2:                        â”‚                              â”‚
â”‚  â”‚     POST razorpay.com/orders          â”‚                              â”‚
â”‚  â”‚     â†“                                 â”‚                              â”‚
â”‚  â”‚     âŒ CONNECTION_ERROR                â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  5. Retry Logic:                      â”‚                              â”‚
â”‚  â”‚     Wait: 2000ms (2^1 * 1000)         â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  6. Attempt 3:                        â”‚                              â”‚
â”‚  â”‚     POST razorpay.com/orders          â”‚                              â”‚
â”‚  â”‚     â†“                                 â”‚                              â”‚
â”‚  â”‚     âœ… SUCCESS { orderId: "ord_123" }  â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚     RETRY CONFIGURATION               â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  const RETRY_CONFIG = {               â”‚                              â”‚
â”‚  â”‚    maxAttempts: 3,                    â”‚                              â”‚
â”‚  â”‚    baseDelay: 1000, // ms             â”‚                              â”‚
â”‚  â”‚    maxDelay: 10000, // ms             â”‚                              â”‚
â”‚  â”‚    exponentialBase: 2,                â”‚                              â”‚
â”‚  â”‚    retryableErrors: [                 â”‚                              â”‚
â”‚  â”‚      'TIMEOUT',                       â”‚                              â”‚
â”‚  â”‚      'CONNECTION_ERROR',              â”‚                              â”‚
â”‚  â”‚      'SERVICE_UNAVAILABLE'            â”‚                              â”‚
â”‚  â”‚    ]                                  â”‚                              â”‚
â”‚  â”‚  }                                    â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  Delay calculation:                   â”‚                              â”‚
â”‚  â”‚  delay = min(                         â”‚                              â”‚
â”‚  â”‚    baseDelay * (exponentialBase ^     â”‚                              â”‚
â”‚  â”‚                 attemptNumber),       â”‚                              â”‚
â”‚  â”‚    maxDelay                           â”‚                              â”‚
â”‚  â”‚  )                                    â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚      WEBHOOK IDEMPOTENCY              â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  Razorpay sends webhook 3 times:      â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  7. Webhook 1:                        â”‚                              â”‚
â”‚  â”‚     { event: "payment.captured",      â”‚                              â”‚
â”‚  â”‚       id: "wh_001",                   â”‚                              â”‚
â”‚  â”‚       orderId: "ord_123" }            â”‚                              â”‚
â”‚  â”‚     â†“                                 â”‚                              â”‚
â”‚  â”‚     âœ… PROCESSED (order_123 marked)   â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  8. Webhook 2 (duplicate):            â”‚                              â”‚
â”‚  â”‚     { event: "payment.captured",      â”‚                              â”‚
â”‚  â”‚       id: "wh_001", ... }             â”‚                              â”‚
â”‚  â”‚     â†“                                 â”‚                              â”‚
â”‚  â”‚     âš ï¸  IGNORED (already processed)   â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  9. Webhook 3 (duplicate):            â”‚                              â”‚
â”‚  â”‚     { event: "payment.captured",      â”‚                              â”‚
â”‚  â”‚       id: "wh_001", ... }             â”‚                              â”‚
â”‚  â”‚     â†“                                 â”‚                              â”‚
â”‚  â”‚     âš ï¸  IGNORED (already processed)   â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                   â”‚                                                     â”‚
â”‚                   â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚       IDEMPOTENCY TRACKING            â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  const processedWebhooks = new Set(); â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚  function handleWebhook(webhook) {    â”‚                              â”‚
â”‚  â”‚    if (processedWebhooks.has(        â”‚                              â”‚
â”‚  â”‚          webhook.id)) {               â”‚                              â”‚
â”‚  â”‚      return {                         â”‚                              â”‚
â”‚  â”‚        status: 'IGNORED',             â”‚                              â”‚
â”‚  â”‚        reason: 'Duplicate'            â”‚                              â”‚
â”‚  â”‚      };                               â”‚                              â”‚
â”‚  â”‚    }                                  â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â”‚    processedWebhooks.add(webhook.id); â”‚                              â”‚
â”‚  â”‚    // Process payment...              â”‚                              â”‚
â”‚  â”‚    return { status: 'PROCESSED' };    â”‚                              â”‚
â”‚  â”‚  }                                    â”‚                              â”‚
â”‚  â”‚                                       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Retry Statistics (Test Results)

```
Attempt 1: Failed (TIMEOUT) - retry in 1000ms
Attempt 2: Failed (CONNECTION_ERROR) - retry in 2000ms
Attempt 3: Success âœ…

Total retries: 2
Total delay: 3000ms
Success rate: 66% recovery (2/3 attempts failed but recovered)
```

---

## Performance Metrics

> **Test Status**: âœ… All flows validated  
> **Total Tests**: 52 (25 original + 27 enhanced)

### Flow Performance Summary

| Flow | Concurrent  Load | Performance | Status |
|------|------------------|-------------|--------|
| User Registration | 10 users | Fast | âœ… |
| Competition Registration | 1000 shooters | < 5 min | âœ… |
| Waitlist Promotion | Auto | < 1 sec | âœ… |
| Score Submission | 200 concurrent | ~2 sec total | âœ… |
| Live Leaderboard | Real-time | < 1 sec update | âœ… |
| Score Dispute | Multi-level | 30min - 24hr | âœ… |
| Team Registration | 10 teams | Fast | âœ… |
| Auto-DQ Checks | Per shooter | < 5 sec | âœ… |
| Medal Allocation | Auto | < 1 sec | âœ… |
| Payment Processing | 500 concurrent | ~2 sec total | âœ… |
| Payment Retry | 3 attempts | 3sec backoff | âœ… |

### Stress Test Results

| Test | Scenario | Result |
|------|----------|--------|
| Registration Spike | 1000 shooters/5min | âœ… Pass |
| Score Burst | 200 concurrent | âœ… Pass |
| Payment Surge | 500 concurrent | âœ… Pass |

---

## Production Deployment

### Phase 1: Core Flows (Week 1)
âœ… User Registration  
âœ… Shooter Profile  
âœ… Competition Registration (with row locking)  
âœ… Score Submission  
âœ… Payment Processing  

### Phase 2: Enhanced Features (Week 2)
âœ… Waitlist Management  
âœ… Live Leaderboard  
âœ… Payment Retry Logic  
âœ… Medal Allocation  

### Phase 3: Advanced Features (Week 3)
âœ… Score Dispute Workflow  
âœ… Team Registration  
âœ… Auto-Disqualification Checks  

### Monitoring Setup

```typescript
// Key metrics to monitor
const metrics = {
  registrationRate: '# registrations/minute',
  waitlistLength: 'current waitlist size',
  leaderboardUpdates: 'updates/second',
  disputesOpen: 'active dispute count',
  disqualifications: 'DQ count per event',
  paymentRetries: 'retry count/success rate',
  medalAllocations: 'medals awarded',
};

// Alerts
alerts = {
  highRegistrationRate: '> 100/min',
  longWaitlist: '> 50 shooters',
  disputeBacklog: '> 10 pending',
  paymentFailures: '> 5% failure rate',
};
```

---

## Quick Reference

### API Endpoints Summary (Updated)

| Flow | Method | Endpoint | Auth | NEW |
|------|--------|----------|------|-----|
| Register | POST | `/api/auth/register` | None | |
| Create Shooter | POST | `/api/shooters` | User | |
| Register Competition | POST | `/api/competitions/:id/register` | Shooter | |
| **Join Waitlist** | POST | `/api/competitions/:id/waitlist` | Shooter | âœ… |
| Submit Score | POST | `/api/scores` | Official | |
| **Dispute Score** | POST | `/api/scores/:id/dispute` | Shooter | âœ… |
| **Register Team** | POST | `/api/teams/register` | Lead | âœ… |
| Create Payment | POST | `/api/payments` | User | |
| Process Refund | POST | `/api/admin/payments/:id/refund` | Admin | |
| Update Classification | POST | `/api/admin/shooters/:id/classification` | Classifier | |
| **Get Leaderboard** | GET | `/api/leaderboard/live/:eventId` | Public | âœ… |
| **Check Equipment** | POST | `/api/equipment/validate` | Official | âœ… |
| **Allocate Medals** | POST | `/api/admin/medals/allocate/:eventId` | Admin | âœ… |

### Transaction Isolation Levels

| Flow | Isolation Level | Reason |
|------|----------------|---------|
| User Registration | READ COMMITTED | Low contention |
| **Competition Registration** | **REPEATABLE READ** | Prevent capacity overrun |
| Score Submission | REPEATABLE READ | Prevent phantom reads |
| Payment Processing | SERIALIZABLE | Money operations |
| **Waitlist Promotion** | **SERIALIZABLE** | Critical ordering |
| **Medal Allocation** | **SERIALIZABLE** | Final results |

---

**Document Version**: 2.0  
**Last Updated**: December 2025  
**Test Coverage**: 52/52 tests passed âœ…  
**Status**: Production Ready ğŸš€  
**New Features**: 7 added and validated
